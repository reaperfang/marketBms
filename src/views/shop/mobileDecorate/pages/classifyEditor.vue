<template>
    <div>
      <!-- 装修编辑器 -->
      <Decorate 
      ref="Decorate" 
      :decorateData="decorateData" 
      :config="config" 
      @widgetPanelInited="widgetPanelInited"
      @renderPanelInited="renderPanelInited"
      @propsPanelInited="propsPanelInited"
      @responseDataInited="responseDataInited"
      @propDataChanged="propDataChanged"
      @dataLoadProgress="dataLoadProgress"
      @finished="finished"
    ></Decorate>

      <!-- 动态弹窗 预览 -->
      <component v-if="dialogVisible" :is="currentDialog" :dialogVisible.sync="dialogVisible" :decorateData="decorateData"></component>
    </div>
</template>

<script>
import utils from "@/utils";
import Decorate from '@/components/Decorate';
import dialogDecoratePreview from '@/components/Decorate/dialogs/dialogDecoratePreview';
import SAVE_BLACK_LIST from '@/components/Decorate/config/saveBlackList'
import widget from '@/components/Decorate/config/widgetConfig';
export default {
  name: "classifyEditor",
  components: {Decorate, dialogDecoratePreview},
  data() {
    return {
      loading: false,
      id: this.$route.query.pageId,
      dialogVisible: false,
      currentDialog: '',
      /* 装修编辑器配置 */
      config: {
        pageBase: {
          type: 'classify'
        },
        components: {
          // 可在此处覆写配置表中的所有组件配置
        },
        buttons: {
          saveData: {
            title: '保存',
            function: this.saveData,
            type: 'primary',
            show: () => true,
            loading: false
          },
          preview: {
            title: '预览',
            function: this.preview,
            type: '',
            show: () => !!this.id,
            loading: false
          },
          cancel: {
            title: '取消',
            function: this.cancelSave,
            type: '',
            show: () => true,
            loading: false
          }
        },
        callbacks: {
          setBaseInfo: this.setBaseInfo
        },
        showWidget: true,
        showProp: true,
        dragable: true,
        widgetCalcHeight: 66, //控件区扣减高度
        renderCalcHeight: 66+10+24,  //渲染区扣减高度
        propCalcHeight: 66 //属性区扣减高度
      },
      decorateData: null
    };
  },
  created() {
    this.$store.commit("clearEditor");
    this.fetch();
  },
  computed: {
    baseInfo() {
      return this.$store.getters.baseInfo;
    },
    componentDataIds() {
      return this.$store.getters.componentDataIds;
    },
    componentDataMap() {
      return this.$store.getters.componentDataMap;
    },
    basePropertyId() {
      return this.$store.getters.basePropertyId;
    }
  },
  methods: {

    /* 获取分类装修数据 */
    fetch() {
      if(!this.id) {
        return;
      };
      this.loading = true;
      this._apis.shop.getClassifyInfo({id: this.id}).then((response)=>{
         this.loading = false;
         this.decorateData = response;
      }).catch((error)=>{
        console.error(error);
        this.loading = false;
      });
    },

     /* 拼装基础数据 */
    setBaseInfo(data) {
      return {
        name: data.name,
        sortType: data.sortType,
        explain: utils.uncompileStr(data.explain),
        showType: data.showType,
        pageInfos: data.pageInfos
      }
    },

    /* 保存数据 */
    saveData() {
      let resultDatas = this.$refs.Decorate.collectData();
      let resultData = utils.deepClone(resultDatas);
      if(resultData && Object.prototype.toString.call(resultData) === '[object Object]') {
        this.id && (resultData['id'] = this.id);
        const copyResultData = {...resultData};
        copyResultData['explain'] = utils.compileStr(copyResultData.explain);
        if(this.checkInput(copyResultData)) {
          this.washData(resultData);
          this.setLoading(true);
          if(this.id) {
            this.sendRequest({methodName: 'editClassifyInfo', resultData: copyResultData, tipWord: '编辑成功!'});
          }else{
            this.sendRequest({methodName: 'createClassify', resultData: copyResultData, tipWord: '创建成功!'});
          }
        };
      }
    },

     /* 检查输入正确性 */
    checkInput(resultData) {
      //检测基础信息
      if(!this.checkBaseInfo(resultData)){
        return false;
      }
      //检测组件有必填条件的则进行验证
      if(!this.checkComponents(resultData)){
        return false;
      }
      return true;
    },

    /* 发起请求 */
    sendRequest(params) {
      let pageData = params.resultData.pageData;
      params.resultData.pageData = this.utils.compileStr(JSON.stringify(pageData));
      this._apis.shop[params.methodName](params.resultData).then((response)=>{
          this.$message.success(params.tipWord);
          this.setLoading(false);
          this._routeTo('m_pageManageIndex');
        }).catch((error)=>{
          this.setLoading(false);
        });
    },

    /* 设置loading */
    setLoading(status) {
      this.config.buttons.saveData.loading = status;
    },

    /* 打开预览 */
    preview() {
      this.dialogVisible=true;
      this.currentDialog='dialogDecoratePreview';
    },

    /* 取消保存 */
    cancelSave() {
      this.confirm({
        title: '确认取消？', 
        customClass: 'goods-custom', 
        icon: true, 
        text: `<h3 style="font-size:18px;color:rgba(68,61,74,1);margin-bottom:10px;">确认取消？</h3><span style="font-size:16px;color:rgba(110,110,114,1);">取消后，放弃当前编辑数据，且无法恢复。</span>`
      }).then(() => {
        this._routeTo('m_pageManageIndex');
      })
    },

    /* 清洗数据 */
    washData(data) {
      let copyData = [...data.pageData];
      for(let item of copyData) {

        /* 图片广告清除无图片或者图片地址无效的数据（临时需求2020/7/7）start  */
        if(item.type === 'articleAD') {
          this.deleteEmptyArticleAD(item);
        }
        /* 图片广告清除无图片或者图片地址无效的数据（临时需求2020/7/  end  */
        const keys = Object.keys(item.data);
        for(let item2 of keys) {
          if(SAVE_BLACK_LIST.includes(item2)) {
            delete item.data[item2];
          }
        }
      }
      data.pageData = copyData;
    },

    /* 删除空的图文广告（临时需求） */
    deleteEmptyArticleAD(data) {
      const templateItemList = [...data.data.itemList];
      for(let i=0;i<templateItemList.length;i++) {
        if(!templateItemList[i].url || !this.utils.validate.isURL(templateItemList[i].url) || !this.utils.validate.isPic(templateItemList[i].url)) {
          templateItemList.splice(i, 1);
          i--;
        }
      }
      data.data.itemList = templateItemList;
    },

    /* 检测基础信息 */
    checkBaseInfo(data) {
      if (this.baseInfo.vError || !data.name || !data.explain) {
        this.$alert('请填写基础信息后重试，点击确认返回编辑分类信息!', '警告', {
          confirmButtonText: '确定',
          callback: action => {
            //打开基础信息面板
            this.$store.commit('setCurrentComponentId', this.basePropertyId);
            this.setLoading(false);
          }
        });
        return false;
      }
      return true;
    },

    /* 检测组件有必填条件的则进行验证 */
    checkComponents(data) {
      for(let item of this.componentDataIds) {
        const componentData = this.componentDataMap[item];
        //检测位置信息组件
        if(componentData.type === 'location' && !this.checkLocation(componentData)){
          return false;
        }
      }
      return true;
    },

    /* 检测位置信息组件 */
    checkLocation(componentData) {
      //如果选择背景图模式，则背景图必填
      const data = componentData.data;
      if(data.bgType === 2 && data.backgroundImage === ''){
        this.$store.commit('setCheckErrorId', uuidv4());
        this.$store.commit('setCurrentComponentId', componentData.id);
        this.setLoading(false);
        return false;
      }
      console.log(data)
      return true;
    },

    /* 控件面板初始化 */
    widgetPanelInited(scope) {
      // console.log('控件面板初始化结束');
    },
    
    /* 渲染面板初始化 */
    renderPanelInited(scope) {
      // console.log('渲染面板初始化结束');
    },
    
    /* 属性面板初始化 */
    propsPanelInited(scope) {
      // console.log('属性面板初始化结束');
    },

    /* 请求数据转换初始化事件 */
    responseDataInited(scope) {
      // console.log('请求数据转换初始化结束');
    },

    /* 组件数据发生改变事件 */
    propDataChanged(scope, id, data) {
      // console.log('组件数据发生改变');
    },

    /* 组件数据加载进度事件 */
    dataLoadProgress(scope, value, component) {
      // console.log('组件数据加载进度');
    },

    /* 编辑器整体加载完毕事件 */
    finished(scope) {
      // console.log('编辑器整体加载完毕');
    }

  }
};
</script>
<style lang="scss" scoped>
/deep/.view {
    .phone-body {
      background:#fff;
    }
}
</style>
